IF(NOT DEFINED ENV{CMAKE_KERNELMODULE_BUILD})
  MESSAGE(FATAL_ERROR "CMAKE_KERNELMODULE_BUILD not defined")
ENDIF()

SET(KERNEL_MODULE_CODE_LIST
    #${CMAKE_CURRENT_SOURCE_DIR}/hello.c
    ${CMAKE_CURRENT_SOURCE_DIR}/binder.c
    ${CMAKE_CURRENT_SOURCE_DIR}/binder.h
    ${CMAKE_CURRENT_SOURCE_DIR}/binder_trace.h
)

SET(KO_BINDER_OUTPUT ${LIBRARY_OUTPUT_PATH}/binder.ko)

ADD_CUSTOM_COMMAND(OUTPUT ${KO_BINDER_OUTPUT}
    COMMAND echo "compiling module buinder.ko"
    COMMAND cp -f ${CMAKE_CURRENT_SOURCE_DIR}/*.h ${CMAKE_CURRENT_BINARY_DIR}/
    COMMAND cp -f ${CMAKE_CURRENT_SOURCE_DIR}/*.c ${CMAKE_CURRENT_BINARY_DIR}/
    COMMAND echo "obj-m := binder.o" > ${CMAKE_CURRENT_BINARY_DIR}/Makefile
    COMMAND make -C $ENV{CMAKE_KERNELMODULE_BUILD} M=${CMAKE_CURRENT_BINARY_DIR} modules
    COMMAND cp -f ${CMAKE_CURRENT_BINARY_DIR}/*.ko ${KO_BINDER_OUTPUT}
    DEPENDS ${KERNEL_MODULE_CODE_LIST}
)
ADD_CUSTOM_TARGET(kmodule ALL
  DEPENDS ${KO_BINDER_OUTPUT})